import subprocess
import json
import datetime
import os

class VulnerabilityScanner:
    def run_lynis_scan(self):
        subprocess.run(["sudo", "lynis", "audit", "system", "--quiet"])
        log = open("/var/log/lynis.log").read()
        return {
            "warnings": log.count("Warning"),
            "suggestions": log.count("Suggestion")
        }

    def check_open_ports(self):
        return {
            "open_ports": subprocess.check_output(["ss", "-tuln"], text=True)
        }

    def check_file_permissions(self):
        critical = ["/etc/passwd", "/etc/shadow"]
        issues = []
        for f in critical:
            if os.stat(f).st_mode & 0o002:
                issues.append(f)
        return {"permission_issues": issues}

    def run_comprehensive_scan(self):
        return {
            "timestamp": datetime.datetime.now().isoformat(),
            "lynis": self.run_lynis_scan(),
            "ports": self.check_open_ports(),
            "permissions": self.check_file_permissions()
        }

    def save_scan_results(self, results):
        file = f"reports/vuln_scan_{int(datetime.datetime.now().timestamp())}.json"
        with open(file, "w") as f:
            json.dump(results, f, indent=2)
        return file
